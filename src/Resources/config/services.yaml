services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false

    # Repository
    Nowo\PerformanceBundle\Repository\RouteDataRepository:
        public: true

    # RouteDataRecord Repository
    Nowo\PerformanceBundle\Repository\RouteDataRecordRepository:
        public: true

    # Services (uses Autowire attributes for parameters)
    Nowo\PerformanceBundle\Service\PerformanceMetricsService:
        public: true
        calls:
            # Optional: message bus for async processing (only if Messenger is available)
            - method: setMessageBus
              arguments: ['@?messenger.bus.default']

    # Cache Service
    Nowo\PerformanceBundle\Service\PerformanceCacheService:
        public: true
        # cachePool is optional and will be null if cache.app is not available
        # The Autowire attribute handles the optional injection

    # Dependency Checker
    Nowo\PerformanceBundle\Service\DependencyChecker:
        public: true

    # Twig Extensions
    Nowo\PerformanceBundle\Twig\IconExtension:
        tags:
            - { name: twig.extension }
    
    Nowo\PerformanceBundle\Twig\ArrayExtension:
        tags:
            - { name: twig.extension }

    # Twig Components (for Symfony UX TwigComponent)
    # These components are auto-discovered by Symfony UX TwigComponent via #[AsTwigComponent] attribute
    # With autoconfigure: true, they should be automatically registered
    # Explicit registration ensures they are available even if autoconfigure doesn't work
    Nowo\PerformanceBundle\Twig\Component\:
        resource: '../../Twig/Component/*'
        public: true
        # No explicit tag needed - #[AsTwigComponent] attribute handles registration
        # Components need to be public for Twig to access them

    # Table Status Checker
    Nowo\PerformanceBundle\Service\TableStatusChecker:
        public: true
        calls:
            # Optional: cache service for caching table status
            - method: setCacheService
              arguments: ['@?Nowo\PerformanceBundle\Service\PerformanceCacheService']

    # Performance Analysis Service
    Nowo\PerformanceBundle\Service\PerformanceAnalysisService:
        public: true

    # Data Collector
    Nowo\PerformanceBundle\DataCollector\PerformanceDataCollector:
        arguments:
            $repository: '@?Nowo\PerformanceBundle\Repository\RouteDataRepository'
            $kernel: '@?kernel'
            $tableStatusChecker: '@?Nowo\PerformanceBundle\Service\TableStatusChecker'
            $dependencyChecker: '@?Nowo\PerformanceBundle\Service\DependencyChecker'
            $recordRepository: '@?Nowo\PerformanceBundle\Repository\RouteDataRecordRepository'
        tags:
            - { name: data_collector, template: '@NowoPerformanceBundle/Collector/performance.html.twig', id: 'performance', priority: 300 }

    # Doctrine Event Subscriber for table name (uses Autowire attribute)
    Nowo\PerformanceBundle\EventSubscriber\TableNameSubscriber:
        tags:
            - { name: doctrine.event_subscriber }

    # Doctrine Event Subscriber for RouteDataRecord table name
    Nowo\PerformanceBundle\EventSubscriber\RouteDataRecordTableNameSubscriber:
        tags:
            - { name: doctrine.event_subscriber }

    # Event Subscriber (uses getSubscribedEvents method and Autowire for parameters)
    Nowo\PerformanceBundle\EventSubscriber\PerformanceMetricsSubscriber:
        tags:
            - { name: kernel.event_subscriber }

    # Query Tracking Connection Subscriber (applies middleware via reflection)
    # Uses #[AsEventListener] attribute for auto-registration, but explicit registration ensures it works
    Nowo\PerformanceBundle\EventSubscriber\QueryTrackingConnectionSubscriber:
        tags:
            - { name: kernel.event_subscriber }

    # Notification Channels
    # Uses Autowire attributes for dependency injection
    Nowo\PerformanceBundle\Notification\Channel\EmailNotificationChannel:
        public: true
        tags:
            - { name: 'nowo_performance.notification_channel', alias: 'email' }

    # Slack webhook channel
    nowo_performance.notification.channel.slack:
        class: Nowo\PerformanceBundle\Notification\Channel\WebhookNotificationChannel
        arguments:
            $httpClient: '@?http_client'
            $webhookUrl: '%nowo_performance.notifications.slack.webhook_url%'
            $format: 'slack'
            $headers: []
            $enabled: '%nowo_performance.notifications.slack.enabled%'
        public: true
        tags:
            - { name: 'nowo_performance.notification_channel', alias: 'slack' }

    # Teams webhook channel
    nowo_performance.notification.channel.teams:
        class: Nowo\PerformanceBundle\Notification\Channel\WebhookNotificationChannel
        arguments:
            $httpClient: '@?http_client'
            $webhookUrl: '%nowo_performance.notifications.teams.webhook_url%'
            $format: 'teams'
            $headers: []
            $enabled: '%nowo_performance.notifications.teams.enabled%'
        public: true
        tags:
            - { name: 'nowo_performance.notification_channel', alias: 'teams' }

    # Generic webhook channel
    nowo_performance.notification.channel.webhook:
        class: Nowo\PerformanceBundle\Notification\Channel\WebhookNotificationChannel
        arguments:
            $httpClient: '@?http_client'
            $webhookUrl: '%nowo_performance.notifications.webhook.url%'
            $format: '%nowo_performance.notifications.webhook.format%'
            $headers: '%nowo_performance.notifications.webhook.headers%'
            $enabled: '%nowo_performance.notifications.webhook.enabled%'
        public: true
        tags:
            - { name: 'nowo_performance.notification_channel', alias: 'webhook' }

    # Notification Service
    Nowo\PerformanceBundle\Service\NotificationService:
        arguments:
            $channels: !tagged_iterator 'nowo_performance.notification_channel'
            $enabled: '%nowo_performance.notifications.enabled%'
        public: true

    # Performance Alert Subscriber
    Nowo\PerformanceBundle\EventSubscriber\PerformanceAlertSubscriber:
        arguments:
            $notificationService: '@?Nowo\PerformanceBundle\Service\NotificationService'
            $requestTimeWarning: '%nowo_performance.thresholds.request_time.warning%'
            $requestTimeCritical: '%nowo_performance.thresholds.request_time.critical%'
            $queryCountWarning: '%nowo_performance.thresholds.query_count.warning%'
            $queryCountCritical: '%nowo_performance.thresholds.query_count.critical%'
            $memoryUsageWarning: '%nowo_performance.thresholds.memory_usage.warning%'
            $memoryUsageCritical: '%nowo_performance.thresholds.memory_usage.critical%'
            $enabled: '%nowo_performance.notifications.enabled%'

    # DBAL Query Tracking Middleware
    Nowo\PerformanceBundle\DBAL\QueryTrackingMiddleware:
        public: false

    # Commands (uses AsCommand attribute, autoconfigure handles the tag)
    Nowo\PerformanceBundle\Command\:
        resource: '../../Command/*'
        tags: ['console.command']

    # Controllers (uses Route attributes, autoconfigure handles the tag)
    Nowo\PerformanceBundle\Controller\:
        resource: '../../Controller/*'

    # Message Handler (uses AsMessageHandler attribute if Messenger is installed)
    # The polyfill ensures this works even without Messenger
    Nowo\PerformanceBundle\MessageHandler\:
        resource: '../../MessageHandler/*'
        exclude: '../../MessageHandler/AsMessageHandlerPolyfill.php'
