{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% block toolbar %}
    {# Always show collector, even when disabled, to provide status information #}
    {% set request_time = collector.requestTime ?? 0 %}
    {% set query_count = collector.queryCount ?? 0 %}
    {% set icon %}
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
        </svg>
        {% if collector.enabled %}
            <span class="sf-toolbar-value">{{ collector.formattedRequestTime }}</span>
        {% else %}
            <span class="sf-toolbar-value" style="color: #999;">Disabled</span>
        {% endif %}
    {% endset %}

    {% set text %}
        {% if collector.enabled %}
            <div class="sf-toolbar-info-piece">
                <b>Request Time</b>
                <span>{{ collector.formattedRequestTime }}</span>
            </div>
            {% if query_count > 0 %}
                <div class="sf-toolbar-info-piece">
                    <b>Queries</b>
                    <span>{{ query_count }} ({{ collector.formattedQueryTime }})</span>
                </div>
            {% endif %}
            <div class="sf-toolbar-info-piece">
                <b>Route</b>
                <span>{{ collector.routeName ?? 'N/A' }}</span>
            </div>
            <div class="sf-toolbar-info-piece">
                <b>Processing</b>
                <span>
                    {% if collector.async %}
                        <span style="color: #4caf50;">● Async</span>
                    {% else %}
                        <span style="color: #2196f3;">● Sync</span>
                    {% endif %}
                </span>
            </div>
            {% if collector.tableName %}
                <div class="sf-toolbar-info-piece">
                    <b>Table</b>
                    <span>
                        {% if collector.tableExists %}
                            {% if collector.tableIsComplete %}
                                <span style="color: #4caf50;">✓ Complete</span>
                            {% else %}
                                <span style="color: #f57c00;">⚠ Incomplete</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #d32f2f;">✗ Missing</span>
                        {% endif %}
                    </span>
                </div>
            {% endif %}
        {% else %}
            <div class="sf-toolbar-info-piece">
                <b>Status</b>
                <span style="color: #999;">Tracking Disabled</span>
            </div>
            <div class="sf-toolbar-info-piece">
                <b>Reason</b>
                <span style="color: #999;">
                    {% if not collector.enabled %}
                        Bundle disabled or environment not tracked
                    {% endif %}
                </span>
            </div>
            {% if collector.tableName %}
                <div class="sf-toolbar-info-piece">
                    <b>Table</b>
                    <span>
                        {% if collector.tableExists %}
                            {% if collector.tableIsComplete %}
                                <span style="color: #4caf50;">✓ Complete</span>
                            {% else %}
                                <span style="color: #f57c00;">⚠ Incomplete</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #d32f2f;">✗ Missing</span>
                        {% endif %}
                    </span>
                </div>
            {% endif %}
        {% endif %}
    {% endset %}

    {% if collector.enabled %}
        {% set status = request_time < 200 ? 'status-success' : (request_time < 500 ? 'status-warning' : 'status-error') %}
        {% if collector.tableName and collector.tableExists and not collector.tableIsComplete %}
            {% set status = 'status-error' %}
        {% endif %}
    {% else %}
        {% set status = 'status-disabled' %}
    {% endif %}
    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', { link: profiler_url, status: status }) }}
{% endblock %}

{% block menu %}
    <span class="label">
        <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        </span>
        <strong>Performance</strong>
    </span>
{% endblock %}

{% block panel %}
    <h2>Performance Metrics</h2>

    {% if not collector.enabled %}
        <div class="empty">
            <p>Performance tracking is disabled.</p>
        </div>
    {% else %}
        <div class="metrics">
            <div class="metric">
                <div class="value">{{ collector.formattedRequestTime }}</div>
                <div class="label">Request Time</div>
            </div>
            {% set query_count = collector.queryCount %}
            {% if query_count > 0 %}
                <div class="metric">
                    <div class="value">{{ query_count }}</div>
                    <div class="label">Database Queries</div>
                </div>
                <div class="metric">
                    <div class="value">{{ collector.formattedQueryTime }}</div>
                    <div class="label">Query Time</div>
                </div>
            {% endif %}
        </div>

        <table>
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Route Name</td>
                    <td><code>{{ collector.routeName ?? 'N/A' }}</code></td>
                </tr>
                <tr>
                    <td>Request Time</td>
                    <td>{{ collector.formattedRequestTime }}</td>
                </tr>
                <tr>
                    <td>Query Count</td>
                    <td>{{ collector.queryCount }}</td>
                </tr>
                <tr>
                    <td>Query Time</td>
                    <td>{{ collector.formattedQueryTime }}</td>
                </tr>
                <tr>
                    <td>Processing Mode</td>
                    <td>
                        {% if collector.async %}
                            <span style="color: #4caf50; font-weight: bold;">● Async</span>
                            <span class="text-muted">(via Messenger)</span>
                        {% else %}
                            <span style="color: #2196f3; font-weight: bold;">● Sync</span>
                            <span class="text-muted">(direct database write)</span>
                        {% endif %}
                    </td>
                </tr>
                {% if collector.accessCount is not null %}
                    <tr>
                        <td>Access Frequency</td>
                        <td>
                            <strong>{{ collector.accessCount }}</strong> time{{ collector.accessCount != 1 ? 's' : '' }}
                            {% if collector.totalRoutes is not null %}
                                <span class="text-muted">(out of {{ collector.totalRoutes }} total routes)</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
                {% if collector.rankingByRequestTime is not null %}
                    <tr>
                        <td>Ranking by Request Time</td>
                        <td>
                            <strong>Position #{{ collector.rankingByRequestTime }}</strong>
                            {% if collector.totalRoutes is not null %}
                                <span class="text-muted">(out of {{ collector.totalRoutes }} routes)</span>
                            {% endif %}
                            {% if collector.rankingByRequestTime <= 3 %}
                                <span style="color: #d32f2f; font-weight: bold;">⚠️ Slow route</span>
                            {% elseif collector.rankingByRequestTime <= 10 %}
                                <span style="color: #f57c00; font-weight: bold;">⚠️ Needs attention</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
                {% if collector.rankingByQueryCount is not null %}
                    <tr>
                        <td>Ranking by Query Count</td>
                        <td>
                            <strong>Position #{{ collector.rankingByQueryCount }}</strong>
                            {% if collector.totalRoutes is not null %}
                                <span class="text-muted">(out of {{ collector.totalRoutes }} routes)</span>
                            {% endif %}
                            {% if collector.rankingByQueryCount <= 3 %}
                                <span style="color: #d32f2f; font-weight: bold;">⚠️ High query count</span>
                            {% elseif collector.rankingByQueryCount <= 10 %}
                                <span style="color: #f57c00; font-weight: bold;">⚠️ Needs optimization</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
                <tr>
                    <td>Database Table</td>
                    <td>
                        {% if collector.tableName %}
                            <code>{{ collector.tableName }}</code>
                            {% if collector.tableExists %}
                                {% if collector.tableIsComplete %}
                                    <span style="color: #4caf50; font-weight: bold;">✓ Complete</span>
                                    <span class="text-muted">(all columns present, ready to store metrics)</span>
                                {% else %}
                                    <span style="color: #f57c00; font-weight: bold;">⚠ Incomplete</span>
                                    <span class="text-muted">(table exists but missing columns)</span>
                                    {% set missingColumns = collector.missingColumns %}
                                    {% if missingColumns is not empty %}
                                        <br>
                                        <small style="color: #d32f2f; font-weight: bold;">
                                            Missing columns: {{ missingColumns|join(', ') }}
                                        </small>
                                        <br>
                                        <small class="text-muted">
                                            Run: <code>php bin/console nowo:performance:create-table --update</code>
                                        </small>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span style="color: #d32f2f; font-weight: bold;">✗ Does not exist</span>
                                <span class="text-muted">(metrics cannot be saved)</span>
                                <br>
                                <small class="text-muted">
                                    Run: <code>php bin/console nowo:performance:create-table</code>
                                </small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not configured</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Data Saved to Database</td>
                    <td>
                        {% if collector.tableExists and collector.tableIsComplete %}
                            {% if collector.wasRecordNew is not null or collector.wasRecordUpdated is not null %}
                                {% if collector.wasRecordNew %}
                                    <span style="color: #4caf50; font-weight: bold;">✓ Saved</span>
                                    <span class="text-muted">(new record created in routes_data table)</span>
                                {% elseif collector.wasRecordUpdated %}
                                    <span style="color: #2196f3; font-weight: bold;">✓ Saved</span>
                                    <span class="text-muted">(existing record updated in routes_data table)</span>
                                {% else %}
                                    <span style="color: #757575; font-weight: bold;">○ Not saved</span>
                                    <span class="text-muted">(metrics were not worse than existing values, no update needed)</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #f57c00; font-weight: bold;">⚠ Unknown</span>
                                <span class="text-muted">(subscriber may not have executed or route was ignored)</span>
                            {% endif %}
                        {% elseif collector.tableExists and not collector.tableIsComplete %}
                            <span style="color: #f57c00; font-weight: bold;">⚠ Not saved</span>
                            <span class="text-muted">(table is incomplete, missing columns)</span>
                        {% elseif not collector.tableExists %}
                            <span style="color: #d32f2f; font-weight: bold;">✗ Not saved</span>
                            <span class="text-muted">(table does not exist)</span>
                        {% else %}
                            <span style="color: #757575; font-weight: bold;">○ Unknown</span>
                            <span class="text-muted">(table status unknown)</span>
                        {% endif %}
                    </td>
                </tr>
                {% if collector.wasRecordNew is not null or collector.wasRecordUpdated is not null %}
                    <tr>
                        <td>Record Operation Details</td>
                        <td>
                            {% if collector.wasRecordNew %}
                                <span style="color: #4caf50; font-weight: bold;">New Record</span>
                                <span class="text-muted">(first time tracking this route in this environment)</span>
                            {% elseif collector.wasRecordUpdated %}
                                <span style="color: #2196f3; font-weight: bold;">Updated Record</span>
                                <span class="text-muted">(metrics were worse than previous values, record updated)</span>
                            {% else %}
                                <span style="color: #757575; font-weight: bold;">No Changes</span>
                                <span class="text-muted">(metrics were not worse than existing values, no update needed)</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    {% endif %}

    <style>
        .metrics {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .metric {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            min-width: 120px;
        }
        .metric .value {
            font-size: 24px;
            font-weight: bold;
            color: #1a1a1a;
        }
        .metric .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
{% endblock %}
